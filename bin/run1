#!/bin/bash

set -e
cd "$(dirname "$0")/.."

if [ "$#" -ne 3 ]; then
    echo "Usage: $0 <nodes_amount> <password> <api_base_url>"
    exit 1
fi

cleanup() {
    echo "Stopping all processes..."
    kill 0
}
trap cleanup SIGINT SIGTERM

# install dependencies
sudo apt install build-essential default-jre default-jdk gradle libssl-dev openssl

# generate keys
bin/generate-keys $2

# compile c++
cd cpp
mkdir -p build
cd build
cmake ..
make
cd ../..

# compile java
cd java
./gradlew shadowJar
cd ..

echo "Starting $1 nodes and sensors..."
cd cpp/build
./node $1 &
./sensor $1 $2 &
cd ../..

echo "Starting intermediate server..."
java -jar build/libs/java-1.0.0-all.jar $1 $3 &
cd ../

wait
